---
title: "Unityã§ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã‚’ä½œã‚‹ãŸã‚ã®Riptideãƒ©ã‚¤ãƒ–ãƒ©ãƒªå…¥é–€ï¼Ÿ #1"
emoji: "ğŸ‘»"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Unity", "csharp", "Riptide"]
published: true
publication_name: midra_lab
---
## ã¯ã˜ã‚ã«
ã“ã‚“ã«ã¡ã¯ã€‚midraã§ã™ã€‚
ä»Šå›ã¯Unityã§ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã‚’ä½œã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚‹Riptideã‚’ä½¿ã£ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚'
ä½•ã‹é¢ç™½ã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒãªã„ã‹[Githubã®Explore](https://github.com/explore)ã‚’è¦‹ã¦ã„ãŸã‚‰ã€å¶ç„¶è¦‹ã¤ã‘ã¾ã—ãŸã€‚
ç­†è€…ã¯Mirrorã‚„FishNetã¨ã„ã£ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ãŸã“ã¨ãŒã‚ã‚Šã¾ã™ãŒã€Riptideã¯ã“ã‚Œã‚‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã¯é•ã†ç‰¹å¾´ã‚’æŒã£ã¦ã„ã‚‹ã®ã§ã€ç´¹ä»‹ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚

## æ¤œè¨¼ç’°å¢ƒ
- Unity 2022.1.22f1
- Riptide 2.0.0
- UniTask 2.3.3

## ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
- [å…¬å¼ã‚µãƒ³ãƒ—ãƒ«](https://github.com/RiptideNetworking/Riptide/tree/main/Demos/Unity/DedicatedServerDemo)
- [è‡ªä½œã‚µãƒ³ãƒ—ãƒ«](https://github.com/eiei114/RiptideSample)

## æ¦‚è¦
Riptideã¯ä¸»ã«ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã§åˆ©ç”¨ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸã‚‚ã§ã™ãŒUnityã ã‘ã§ãªãã€.NET Coreã‚„.NET Frameworkã§ã‚‚åˆ©ç”¨ã§ãã¾ã™ã€‚
2021å¹´5æœˆ27æ—¥v0.1.0ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ã„ã¦ã€ã“ã®è¨˜äº‹ã®ä½œæˆæ®µéšã§ã®æœ€æ–°ç‰ˆã¯2022å¹´10æœˆ9æ—¥ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸV2.0.0ã®ã‚‚ã®ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
é–‹ç™ºè€…ã¯[Tom Weiland](https://www.youtube.com/@tomweiland)æ°ã§ã€[Kevin Kaymak](https://www.youtube.com/channel/UCThwyD-sY4PwFm7EM89shhQ)æ°ã®å‹•ç”»ã§ã‹ã‚‰ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®æ§‹ç¯‰æ–¹æ³•ã‚’å­¦ã³
Riptideã®é–‹ç™ºã«å–ã‚Šçµ„ã¿å§‹ã‚ãŸã‚ˆã†ã§ã™ã€‚å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ¦‚è¦ã‹ã‚‰æ¨æ¸¬ã«ã“ã‚Œã‚’é–‹ç™ºã—ã¦ã„ãä¸­ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®å®Ÿè£…ã«é–¢ã™ã‚‹å­¦ç¿’ã‚‚ã‹ã­ã¦ã„ã‚‹ã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã—ãŸã€‚
> "This is ideal if you like to be in control of your code and know what's going on under the hood."
>
> "ã“ã‚Œã¯ã€ã‚³ãƒ¼ãƒ‰ã‚’åˆ¶å¾¡ã—ã€å†…éƒ¨ã§ä½•ãŒèµ·ã“ã£ã¦ã„ã‚‹ã‹ã‚’çŸ¥ã‚ŠãŸã„å ´åˆã«ç†æƒ³çš„ã§ã™ã€‚"
> 
> https://riptide.tomweiland.net/manual/overview/about-riptide.html 

## å°å…¥æ–¹æ³•
### Unity Package Manager
Unityã®Package Managerã‹ã‚‰å°å…¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
1. Unityã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ã‹ã‚‰`Window` -> `Package Manager`ã‚’é¸æŠã—ã¾ã™ã€‚
2. `+`ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦`Add package from git URL...`ã‚’é¸æŠã—ã¾ã™ã€‚
3. æ¬¡ã® URL ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„: https://github.com/RiptideNetworking/Riptide.git?path=/Packages/Core#2.0.0ã€‚v2.0.0 ä»¥å¤–ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã«ã¯ã€ ã®2.0.0å¾Œã®#ã‚’é¸æŠã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã«ç½®ãæ›ãˆã¾ã™ã€‚
4. `Add`ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

### ãã®ä»–å°å…¥æ–¹æ³•
(https://riptide.tomweiland.net/manual/overview/installation.html)

## ä½¿ã„æ–¹
ã§ãã‚‹ã“ã¨ã¯å˜ç´”æ˜å¿«ã§ã€**_ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•_**ã€**_ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®æ¥ç¶š_**ã€**_ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€å—ä¿¡_**ã€**_ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®æ¥ç¶šçŠ¶æ³ã«é–¢ã™ã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯_** ã¨ãªã£ã¦ã„ã¾ã™ã€‚(ã¾ã ã¾ã æ©Ÿèƒ½ã¯ã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã§å¿…è¦ãªæœ€ä½é™ã®æ©Ÿèƒ½ã ã‘ç´¹ä»‹ã—ã¦ã„ãã¾ã™ã€‚)
ä»Šå›ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µãƒ¼ãƒãƒ¼ãƒ¢ãƒ‡ãƒ«ã®å°‚ç”¨ã‚µãƒ¼ãƒãƒ¼å‹ã‚’æ¡ç”¨ã—ã¦ã„ãã¾ã™ã€‚

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
ã‚µãƒ³ãƒ—ãƒ«ã‚’è¦‹ã¦ã‚‚ã‚‰ã£ãŸã‚‰ã‚ã‹ã‚‹é€šã‚Šã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã‚µãƒ¼ãƒãƒ¼ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆ†ã‘ã¦ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã—ã¦ä¸¡æ–¹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«Riptideã‚’å°å…¥ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•
ã‚µãƒ¼ãƒãƒ¼å´ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§`NetworkManager`ã‚’ä½œæˆã—ã¾ã™ã€‚

```
    public class NetworkManager : MonoBehaviour
    {
        //èµ·å‹•ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ã®ãƒãƒ¼ãƒˆç•ªå·ã¨æœ€å¤§æ¥ç¶šæ•°ã‚’è¨­å®š
        [SerializeField] private ushort port;
        [SerializeField] private ushort maxConnections;
        //ã‚µãƒ¼ãƒãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹(Riptideã®APIã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«å¿…è¦)
        private Server _server;

        private void Start()
        {
            QualitySettings.vSyncCount = 0;
            Application.targetFrameRate = 30;

#if UNITY_EDITOR
            //Riptideå°‚ç”¨ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’å‡ºåŠ›ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            RiptideLogger.Initialize(Debug.Log, Debug.Log, Debug.LogWarning, Debug.LogError, false);
#else
            //ã‚³ãƒ³ã‚½ãƒ¼ãƒ«åˆæœŸåŒ–
            Console.Title = "Server";
            Console.Clear();
            //(https://docs.unity3d.com/ja/2018.4/ScriptReference/Application.SetStackTraceLogType.html)
            // ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ãŒãƒ­ã‚°ã«å‡ºåŠ›ã•ã‚Œã¾ã›ã‚“
            Application.SetStackTraceLogType(UnityEngine.LogType.Log, StackTraceLogType.None);
            RiptideLogger.Initialize(Debug.Log, true);
#endif
            //ã‚µãƒ¼ãƒãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ
            _server = new Server();
            //ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šæ™‚ã€åˆ‡æ–­æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™»éŒ²
            _server.ClientConnected += ClientConnected;
            _server.ClientDisconnected += ClientDisconnected;
            //ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•
            _server.Start(port, maxConnections);
        }

        private void FixedUpdate()
        {
            // ã‚µãƒ¼ãƒãƒ¼ãŒæ¥ç¶šã‚’å—ã‘å…¥ã‚Œã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            _server.Update();
        }

```

#### ä¸€ã¤ã¾ã¿
```
            QualitySettings.vSyncCount = 0;
            Application.targetFrameRate = 30;
```

VSyncã¨ã„ã†ã®ã¯ã€Œãƒ¢ãƒ‹ã‚¿ãƒ¼ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ¬ãƒ¼ãƒˆ(ã¤ã¾ã‚Šç”»é¢ã‚’æ›´æ–°ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°)ã«åˆã‚ã›ã¦ã‚²ãƒ¼ãƒ ç”»é¢ã‚’æç”»ã™ã‚‹ã€æ©Ÿèƒ½ã®ã“ã¨ã§ã™ã€‚
ã‚µãƒ¼ãƒãƒ¼å´ãªã®ã§ç”»é¢ã«æç”»ã™ã‚‹å¿…è¦ã¯ãªã„ã®ã§ã€VSyncã‚’ç„¡åŠ¹ã«ã—ã¦ã„ã¾ã™ã€‚
(https://sleepygamersmemo.blogspot.com/2017/05/unity-fixed-frame-rate.html)

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆã¯é”æˆå¯èƒ½ãªæœ€å¤§ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆã«ãªã£ã¦ã„ã‚‹ã®ã§ã€30ã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚
(https://bibinbaleo.hatenablog.com/entry/2021/01/31/215652)

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®æ¥ç¶š

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§`NetworkManager`ã‚’ä½œæˆã—ã¾ã™ã€‚

```
    public class NetworkManager : MonoBehaviour
    {
        //ã‚µãƒ¼ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒãƒ¼ãƒˆç•ªå·ã‚’è¨­å®š
        //ä»Šå›ã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ›ã‚¹ãƒˆã‚’æŒ‡å®š
        [SerializeField] private string ip = "127.0.0.1";
        [SerializeField] private ushort port = 7777;
        //ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹(Riptideã®APIã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«å¿…è¦)
        private Client _client;

        private void Awake()
        {
            //Riptideå°‚ç”¨ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’å‡ºåŠ›ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            RiptideLogger.Initialize(Debug.Log, Debug.Log, Debug.LogWarning, Debug.LogError, false);

            //ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ  
            _client = new Client();
            //ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¥ç¶šæ™‚ã€åˆ‡æ–­æ™‚ãªã©ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™»éŒ²
            _client.Connected += MyClientConnect;
            _client.ClientConnected += OtherClientConnect;
            _client.ConnectionFailed += FailedToConnect;
            _client.ClientDisconnected += PlayerLeft;
            _client.Disconnected += DidDisconnect;
        }
        
        private void FixedUpdate()
        {
            // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®æ¥ç¶šã‚’å—ã‘å…¥ã‚Œã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            _client.Update();
        }
        //ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ãŸã„ã¨ãã«å‘¼ã³å‡ºã™
        public void Connect()
        {
            _client.Connect($"{ip}:{port}");
        }
        //ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šã‚’åˆ‡æ–­ã—ãŸã„ã¨ãã«å‘¼ã³å‡ºã™
        public void Disconnect()
        {
            _client.Disconnect();
        }
```

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€å—ä¿¡(å¤‰æ•°ã®åŒæœŸã‹ã‚‰ã‚µãƒ¼ãƒãƒ¼ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå…±ã«å‡¦ç†ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹äº‹ãŒã§ãã‚‹)
#### å‡¦ç†ã®é †åºä¸€ä¾‹
> åå‰ã‚’å…¥åŠ›ã—ã¦ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ã€ãã®æ›´æ–°å‡¦ç†ã‚’å„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€ä¿¡ã™ã‚‹ã€‚
> 
> ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ -> ã‚µãƒ¼ãƒãƒ¼ -> ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
>

**Unityã§å®Ÿè£…ã™ã‚‹ã¨ã—ãŸã‚‰â€¦**
1. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§InputFieldã«åå‰ã‚’å…¥åŠ›ã™ã‚‹
2. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—åå‰æƒ…å ±ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã™ã‚‹
3. ã‚µãƒ¼ãƒãƒ¼å´ã§åå‰æƒ…å ±ã‚’å—ã‘å–ã‚Šã€åå‰æƒ…å ±ã‚’æ›´æ–°ã™ã‚‹
4. ã‚µãƒ¼ãƒãƒ¼å´ã§åå‰æƒ…å ±ã‚’å„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€ä¿¡ã™ã‚‹

#### ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰
**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰**

View.cs
```
    public class View : MonoBehaviour
    {
        [SerializeField] private TMP_InputField _inputField;
        [SerializeField] private Button _connectButton;
        [SerializeField] private TMP_Text _nameText;
        
        private readonly UnityEvent<string> _connectEvent = new();

        public UnityEvent<string> OnConnectButtonClicked => _connectEvent;
        
        public string Name
        {
            set => _nameText.text = value;
        }
        
        private void Awake()
        {
            _connectButton.onClick.AddListener(() => OnConnectButtonClicked?.Invoke(_inputField.text));
        }
    }
```

Manager.cs
```
    public class Manager : MonoBehaviour
    {
        [SerializeField] private NetworkManager _networkManager;
        [SerializeField] private View _view;
        
        private void Start()
        {
            _view.OnConnectButtonClicked.AddListener((name) =>
            {
                _networkManager.SendSetPlayerNameMessage(name);
            });
            
            _networkManager.OnSetName.AddListener((id, name) =>
            {
                //åå‰ã‚’æ›´æ–°ã™ã‚‹å‡¦ç†
                Name = name;
                
                //idã‚’å—ã‘å–ã‚‹ã“ã¨ã§ã€è‡ªåˆ†ã®åå‰ã‚’æ›´æ–°ã—ãŸã‹ã€ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åå‰ã‚’æ›´æ–°ã—ãŸã‹ã‚’åˆ¤æ–­ã§ãã‚‹ã‚ˆã†ãªå®Ÿè£…ã‚‚å¯èƒ½ã«ãªã‚‹
            });
        }
    }
```

NetworkManager.cs
```
    public enum ServerToClientId : ushort
    {
        //"= 1"ã¯ç¢ºå®Ÿã«ä»˜ã‘ã‚‹ã€‚
        SetClientPlayerName = 1,
        AddScore,
    }

    public enum ClientToServerId : ushort
    {
        SetServerPlayerName = 1,
        AddScore,
    }

    public class NetworkManager : MonoBehaviour
    {
    
    //--------------çœç•¥----------------
    
        private static readonly UnityEvent<ushort, string> _onSetName = new();
        public UnityEvent<ushort, string> OnSetName => _onSetName;
    
        //ã‚µãƒ¼ãƒãƒ¼ã«åå‰ã‚’é€ä¿¡ã™ã‚‹
        public void SendSetPlayerNameMessage(string name)
        {
            //ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã«é€ã‚‹ãŸã‚ã«Mesageã‚’ä½œæˆ
            //ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®Riptideå°‚ç”¨ã®å—ä¿¡ãƒ¡ã‚½ãƒƒãƒ‰ã«ã¤ãattributeã®ID("ClientToServerId.SetPlayerName")ã‚’æŒ‡å®š
            var message = Message.Create(MessageSendMode.Reliable, ClientToServerId.SetPlayerName);
            //åå‰ã‚’é€ä¿¡
            message.AddString(username);
            //ã‚µãƒ¼ãƒãƒ¼ã«åå‰ã‚’é€ä¿¡
            _client.Send(message);
        }
        
        //ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰åå‰ã‚’å—ä¿¡ã™ã‚‹
        //staticãƒ¡ã‚½ãƒƒãƒ‰ã§ãªã‘ã‚Œã°ãªã‚‰ãªã„
        [MessageHandler((ushort)ServerToClientId.SetClientPlayerName)]
        private static void RecieveSetPlayerName(Message message)
        {
            //ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å—ã‘å–ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰åå‰ã¨IDã‚’å–å¾—
            var id = message.GetUShort();
            var username = message.GetString();
            
            //staticãªUnityEventã‚’å‘¼ã³å‡ºã™
            //IDã¨åå‰ã‚’å¼•æ•°ã«æ¸¡ã™
            _onSetName?.Invoke(id, username);
        }
    }
        
```

**ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰** 

Model.cs
```
    public class Model : MonoBehaviour
    {
        private ushort _id;
        private AsyncReactiveProperty<string> _username = new ("");
        
        public ushort Id => _id;
        public AsyncReactiveProperty<string> Username => _username;

        public ushort SetId
        {
            set => _id = value;
        }
        
        public string SetUsername
        {
            set => _username.Value = value;
        }
    }
```

Manager.cs
```
    public class Manager : MonoBehaviour
    {
        [SerializeField] private NetworkManager _networkManager;
        [SerializeField] private Model _model;

        private void Start()
        {
            _networkManager.OnSetName.AddListener((id, name) =>
            {
                //åå‰ã¨idã‚’æ›´æ–°ã™ã‚‹å‡¦ç†
                _model.SetId = id;
                _model.SetUsername = name;
            });
            
            _model.Username.Subscribe(name =>
            {
                //åå‰ã‚’æ›´æ–°ã—ãŸã‚‰ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«åå‰ã‚’é€ä¿¡ã™ã‚‹
                _networkManager.SendSetPlayerNameMessage(_model.Id,name);
            });
        }
    }
```

NetworkManager.cs
```
    //ã‚µãƒ¼ãƒãƒ¼å´ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã¯ã¨ã‚‚ã«åŒã˜ç‰©ã‚’ç”¨æ„ã™ã‚‹äº‹ã‚’å¿˜ã‚Œãšã«ï¼ï¼
    public enum ServerToClientId : ushort
    {
        //"= 1"ã¯ç¢ºå®Ÿã«ä»˜ã‘ã‚‹ã€‚
        SetClientPlayerName = 1,
        AddScore,
    }

    public enum ClientToServerId : ushort
    {
        SetServerPlayerName = 1,
        AddScore,
    }

    public class NetworkManager : MonoBehaviour
    {
    //--------------çœç•¥----------------

        private static readonly UnityEvent<ushort, string> _onSetName = new();
        public UnityEvent<ushort, string> OnSetName => _onSetName;

        public void SendSetPlayerNameMessage(ushort userid, string username)
        {
            //ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã«é€ã‚‹ãŸã‚ã«Mesageã‚’ä½œæˆ
            var message = Message.Create(MessageSendMode.Reliable, ServerToClientId.SetClientPlayerName);
            //åå‰ã¨IDã‚’é€ä¿¡
            message.AddUShort(userid);
            message.AddString(username);
            //ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«åå‰ã‚’é€ä¿¡ã€‚ç¬¬äºŒå¼•æ•°ã¯é€ä¿¡å…ˆã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID
            _server.Send(message, userid);
            
            //å…¨ã¦ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€ä¿¡ã™ã‚‹å ´åˆã¯
            //_server.SendToAll(message);
            
            //ç‰¹å®šã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä»¥å¤–ã«é€ä¿¡ã™ã‚‹å ´åˆã¯
            //_server.SendToAll(message, userid);
        }
        
        //ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰åå‰ã¨ãã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç‹¬è‡ªãŒæŒã¤IDã‚’å—ä¿¡ã™ã‚‹
        //staticãƒ¡ã‚½ãƒƒãƒ‰ã§ãªã‘ã‚Œã°ãªã‚‰ãªã„
        [MessageHandler((ushort)ClientToServerId.SetServerPlayerName)]
        private static void RecieveSetPlayerName(ushort fromClientId, Message message)
        {
            var username = message.GetString();
            //ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ãŸéš›ã«ã‚µãƒ¼ãƒãƒ¼å´ã§è‡ªå‹•çš„ã«å‰²ã‚ŠæŒ¯ã‚‰ã‚Œã‚‹
            //ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹éš›ã«è‡ªå‹•çš„ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®IDãŒä»˜ä¸ã—ã¦ãã‚‹ã®ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§IDã‚’é€ã‚‹ãŸã‚ã®æ˜ç¤ºçš„ãªå‡¦ç†ã¯ä¸è¦
            _onSetName.Invoke(fromClientId, username);
        }
    }
```

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã‚µãƒ¼ãƒãƒ¼å´ã®æ¥ç¶šçŠ¶æ³ã«å¿œã˜ãŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«ã¤ã„ã¦

#### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®æŒã¤ä¸»è¦ãªã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
```
            //è‡ªåˆ†ãŒã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šå®Œäº†ã—ãŸæ™‚
            _client.Connected += MyClientConnect;
            //ä»–ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ãŸæ™‚
            _client.ClientConnected += OtherClientConnect;
            //è‡ªåˆ†ãŒã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šå¤±æ•—ã—ãŸæ™‚
            _client.ConnectionFailed += FailedToConnect;
            //ä»–ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰åˆ‡æ–­ã—ãŸæ™‚
            _client.ClientDisconnected += PlayerLeft;
            //è‡ªåˆ†ãŒã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰åˆ‡æ–­ã—ãŸæ™‚
            _client.Disconnected += DidDisconnect;
```

#### ã‚µãƒ¼ãƒãƒ¼å´ã®æŒã¤ä¸»è¦ãªã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
```
            //ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ãŸæ™‚
            _server.ClientConnected += OnClientConnected;
            //ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰åˆ‡æ–­ã—ãŸæ™‚
            _server.ClientDisconnected += OnClientDisconnected;
```

## ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¤ã„ã¦
ã“ã‚Œã¾ã§ã®å†…å®¹ã‚’ã¾ã¨ã‚ãŸã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚
ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã®è¨­è¨ˆã«ã¤ã„ã¦ã¯ã¾ã ã¾ã çµŒé¨“ãŒå°‘ãªã„ã®ã§ã€é–“é•ã„ã‚„æ”¹å–„ç‚¹ãŒã‚ã‚Œã°ã”æŒ‡æ‘˜ã„ãŸã ã‘ã‚‹ã¨å¹¸ã„ã§ã™ã€‚
ã–ã£ãã‚Šã¨ã¾ã¨ã‚ãŸå›³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚
![Architecture](images/61ae2fd87929fc/project.png)

è¦‹ã¦ã®é€šã‚Šã‚µãƒ¼ãƒãƒ¼å´ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã¯å…±ã«MVPãƒ‘ã‚¿ãƒ¼ãƒ³ã½ã„è¨­è¨ˆã«ãªã£ã¦ã„ã¾ã™ã€‚æœ¬æ¥ã§ã‚ã‚Œã°ã‚µãƒ¼ãƒãƒ¼ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãã‚Œãã‚Œã«ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¿ãƒ¼ã§ç›´æ¥NetworkManagerã‚’å‘¼ã³å‡ºã•ãšã«ã€
ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹å°‚ç”¨ã®ãƒ¢ãƒ‡ãƒ«ã‚’ç”Ÿæˆã—ã€ãã®ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¿ãƒ¼ãŒç›£è¦–ã™ã‚‹ã‚ˆã†ã«ã•ã›ãŸã‹ã£ãŸã§ã™ã€‚

## ã¾ã¨ã‚
Riptideã¯APIã®æ•°ãŒå°‘ãªãã€åˆ©ç”¨æ–¹æ³•ãŒå˜ç´”æ˜å¿«ã§ã™ãŒã€ä»–ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª(Mirrorã‚„FishNetã€Photonãªã©)ã¨ã¯ç•°ãªã‚Šã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒç”¨æ„ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€åˆå¿ƒè€…ã«ã¯é›£ã—ã„ã¨æ„Ÿã˜ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
ãã†ã„ã†ç†ç”±ã‚‚ã‚ã£ã¦ã‹ã€NetworkLibraryã«é–¢ã™ã‚‹ç†è§£ã‚’æ·±ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ã¾ã ã¾ã æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚‹ã¨æ€ã†ã®ã§ã€ä»Šå¾Œã‚‚æ©Ÿèƒ½ãŒè¿½åŠ ã•ã‚Œã¦ã„ãã“ã¨ã‚’æœŸå¾…ã—ã¦ã„ã¾ã™ã€‚


