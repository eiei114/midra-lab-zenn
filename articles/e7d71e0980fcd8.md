---
title: "NotionAPIã¨GithubActionsã§è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼Ÿæ©Ÿèƒ½ã‚’ä½œã£ã¦ã¿ãŸ"
emoji: "ğŸ“‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [notionapi, githubactions, python]
published: true
publication_name: midra_lab
---
## ã¯ã˜ã‚ã«
ç­†è€…ã¯å®Œå…¨åˆå¿ƒè€…ã®Pythonã®å­¦ç¿’è€…ã§ã™ã€‚æ™®æ®µã¯C#ã‚’ä½¿ã£ã¦é–‹ç™ºã‚’ã—ã¦ã„ã¾ã™ã€‚
æƒ…å ±å­¦ã«é–¢ã—ã¦æ·±ã„çŸ¥è¦‹ã‚’æŒã£ã¦ã„ã‚‹ã‚ã‘ã§ã‚ƒãªã„ã®ã§ã€é–“é•ã£ã¦ã„ã‚‹ã¨ã“ã‚ãŒã‚ã‚Œã°ã”æŒ‡æ‘˜ã„ãŸã ã‘ã‚‹ã¨å¹¸ã„ã§ã™ã€‚
ä»Šå›ã¯main.pyã«ã¹ãŸæ›¸ãã—ã¦ã„ã‚‹ã®ã§è¦‹è‹¦ã—ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã”äº†æ‰¿ãã ã•ã„ã¾ã›ã€‚

ç­†è€…ã¯å€‹äººçš„ãªTodoã‚’Notionã§ç®¡ç†ã—ã¦ã„ã¦ã‚ˆã‚Šè‡ªåˆ†å¥½ã¿ã«è‡ªå‹•åŒ–ã§ãã‚Œã°ã‚ˆã‚ŠåŠ¹ç‡ã®è‰¯ã„ã‚¿ã‚¹ã‚¯ç®¡ç†ãŒã§ãã‚‹ã®ã§ã¯ãªã„ã‹ã¨è€ƒãˆã¦ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚

## ä»Šå›ä½œæˆã—ãŸã‚‚ã®
ã‚¿ã‚¤ãƒˆãƒ«è©æ¬ºã«ã¯ãªã£ã¦ã—ã¾ã„ã¾ã™ãŒå®Ÿéš›ã«ã¯ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¦å®Œå…¨ã«è¨˜äº‹ã‚’å‰Šé™¤ã¨ã„ã†ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ä»Šå›ã¯ãƒšãƒ¼ã‚¸ã®æŒã¤selectãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§Todoãƒšãƒ¼ã‚¸ã®é€²è¡ŒçŠ¶æ³ã‚’ç®¡ç†ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
selectãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã¯'In Progress'ã¨'Done','Archive'ã®3ã¤ã®å€¤ã‚’æŒãŸã›ã¦ã„ã¾ã™ã€‚
'In Progress'ã¯ã‚¿ã‚¹ã‚¯ãŒæœªå®Œäº†ã§'Done'ã¯ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ãŸçŠ¶æ…‹ã§ã™ã€‚
'Archive'ã¯ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ãŸçŠ¶æ…‹ã§ã€å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã™ã‚‹ãŸã‚ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§ã™ã€‚

![notion_select.png](..%2Fimages%2Fe7d71e0980fcd8%2Fnotion_select.png)

å®Ÿè£…ã™ã‚‹æ©Ÿèƒ½ã¯ã€å˜ç´”ã«1æ—¥ã«1å›'Done'ã«ãªã£ã¦3æ—¥ãŸã£ãŸã‚¿ã‚¹ã‚¯ã‚’'Archive'ã«å¤‰æ›´ã™ã‚‹ã ã‘ã®æ©Ÿèƒ½ã§ã™ã€‚

## ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒã‚¸ãƒˆãƒª

(https://github.com/eiei114/NotionAutoStatusArchive)

## å®Ÿè£…æ–¹æ³•
å®Ÿè£…æ‰‹é †ã¨ã—ã¦ã¯ä»¥ä¸‹ã®é€šã‚Šã«ãªã‚Šã¾ã™ã€‚
1. NotionAPIã‚’ä½¿ã£ã¦Notionã®ãƒšãƒ¼ã‚¸ã‚’å–å¾—ã™ã‚‹
2. å–å¾—ã—ãŸãƒšãƒ¼ã‚¸ã®selectãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç¢ºèªã™ã‚‹
3. selectãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒ'Done'ã§ã‹ã¤3æ—¥ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã‚’'Archive'ã«å¤‰æ›´ã™ã‚‹
4. å¤‰æ›´ã—ãŸã‚¿ã‚¹ã‚¯ã‚’Notionã«åæ˜ ã™ã‚‹
5. GithubActionsã§å®šæœŸå®Ÿè¡Œã™ã‚‹

## NotionAPIæ“ä½œéƒ¨åˆ†
```python
load_dotenv()

notion = Client(auth=os.getenv('NOTION_API_KEY'))
database_id = os.getenv('DATABASE_ID')

db = notion.databases.query(
    **{
        'database_id': database_id,
        'filter': {
            'property': 'Select',
            'select': {
                'equals': 'Done'
            },
        },
    }
)

now = datetime.datetime.now(datetime.timezone.utc)

if not db:
    print("There are no results to update.")
else:
    db = db["results"]
    for result in db:
        page_id = result["id"]
        last_edited_time = datetime.datetime.fromisoformat(result["last_edited_time"][:-1] + '+00:00')
        delta = now - last_edited_time

        if delta.days > 3:
            notion.pages.update(
                **{
                    'page_id': page_id,
                    'properties': {
                        'Select': {
                            'select': {
                                'name': 'Archive'
                            },
                        },
                    }
                })

        print(f"Page {page_id} has been updated.")
```
- `load_dotenv()` : .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
- `notion = Client(auth=os.getenv('NOTION_API_KEY'))` : NotionAPIã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹
- `database_id = os.getenv('DATABASE_ID')` : .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®IDã‚’å–å¾—ã™ã‚‹
- `db = notion.databases.query(**{ 'database_id': database_id, 'filter': { 'property': 'Select', 'select': { 'equals': 'Done' } } })` : ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰selectãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒ'Done'ã®ãƒšãƒ¼ã‚¸ã‚’å–å¾—ã™ã‚‹
- `now = datetime.datetime.now(datetime.timezone.utc)` : ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—ã™ã‚‹
- `if not db: print("There are no results to update.")` : å–å¾—ã—ãŸãƒšãƒ¼ã‚¸ãŒãªã‘ã‚Œã°å‡¦ç†ã‚’çµ‚äº†ã™ã‚‹
- `db = db["results"]` : å–å¾—ã—ãŸãƒšãƒ¼ã‚¸ã‚’dbã«æ ¼ç´ã™ã‚‹
- `for result in db:` : å–å¾—ã—ãŸãƒšãƒ¼ã‚¸ã‚’1ã¤ãšã¤å‡¦ç†ã™ã‚‹
- `page_id = result["id"]` : å–å¾—ã—ãŸãƒšãƒ¼ã‚¸ã®IDã‚’å–å¾—ã™ã‚‹
- `last_edited_time = datetime.datetime.fromisoformat(result["last_edited_time"][:-1] + '+00:00')` : å–å¾—ã—ãŸãƒšãƒ¼ã‚¸ã®æœ€çµ‚æ›´æ–°æ—¥æ™‚ã‚’å–å¾—ã™ã‚‹
- `delta = now - last_edited_time` : å–å¾—ã—ãŸãƒšãƒ¼ã‚¸ã®æœ€çµ‚æ›´æ–°æ—¥æ™‚ã¨ç¾åœ¨æ™‚åˆ»ã®å·®åˆ†ã‚’å–å¾—ã™ã‚‹
- `if delta.days > 3:` : å–å¾—ã—ãŸãƒšãƒ¼ã‚¸ã®æœ€çµ‚æ›´æ–°æ—¥æ™‚ã¨ç¾åœ¨æ™‚åˆ»ã®å·®åˆ†ãŒ3æ—¥ä»¥ä¸Šã‚ã‚Œã°ä»¥ä¸‹ã®å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹
- `notion.pages.update(**{ 'page_id': page_id, 'properties': { 'Select': { 'select': { 'name': 'Archive' } }, } })` : å–å¾—ã—ãŸãƒšãƒ¼ã‚¸ã®selectãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’'Archive'ã«å¤‰æ›´ã™ã‚‹
- `print(f"Page {page_id} has been updated.")` : å–å¾—ã—ãŸãƒšãƒ¼ã‚¸ã®IDã‚’å‡ºåŠ›ã™ã‚‹

### å…ƒã€…ã¯statusãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ã£ã¦ã„ãŸãŒã€‚ã€‚
APIã‚’ä½¿ã£ã¦æ›´æ–°ã™ã‚‹ã“ã¨ãŒã§ããªã„ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚
ãƒšãƒ¼ã‚¸ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã¯å–å¾—ã¯ã§ãã‚‹ãŒæ›´æ–°ã¯ã§ããªã„ã‚‚ã®ã‚‚ã‚ã‚‹ã‚ˆã†ãªã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚
(https://developers.notion.com/reference/page-property-values)


## GithubActionséƒ¨åˆ†
```yaml
name: Daily Update

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.9
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install python-dotenv
      - name: Run script
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          DATABASE_ID: ${{ secrets.DATABASE_ID }}
        run: |
          python main.py
```
- `name: Daily Update` : GithubActionsã®åå‰ã‚’è¨­å®šã™ã‚‹
- `on:` : GithubActionsã®å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’è¨­å®šã™ã‚‹
- `schedule:` : å®šæœŸå®Ÿè¡Œã™ã‚‹
- `- cron: '0 0 * * *'` : æ¯æ—¥0æ™‚ã«å®Ÿè¡Œã™ã‚‹
- `- name: Checkout code` : GithubActionsã§å®Ÿè¡Œã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹
- `- name: Setup Python` : Pythonã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨­å®šã™ã‚‹
- `- name: Install dependencies` : å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
- `- name: Run script` : Pythonã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹
- `env:` : ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹
- `NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}` : .envãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¼‰ã—ãŸNotionAPIã®ã‚­ãƒ¼ã‚’è¨­å®šã™ã‚‹
- `DATABASE_ID: ${{ secrets.DATABASE_ID }}` : .envãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¼‰ã—ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®IDã‚’è¨­å®šã™ã‚‹
- `python main.py` : Pythonã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹

## ã¾ã¨ã‚
ä»Šå›ã¯Notionã®ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚’è‡ªå‹•åŒ–ã™ã‚‹ä¸€éƒ¨æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
å®Ÿã¯GithubActionsã®ymalãƒ•ã‚¡ã‚¤ãƒ«ã‚‚æ›¸ãã®ã‚‚åˆã‚ã¦ã§ã—ãŸãŒã€ç°¡å˜ã«æ›¸ã‘ã¦ä¾¿åˆ©ã ãªã¨æ€ã„ã¾ã—ãŸã€‚
ä»Šå¾Œã¯å€‹äººã ã‘ã§ãªããƒãƒ¼ãƒ ã‚„ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã§ã®æ´»ç”¨æ–¹æ³•ã‚‚è€ƒãˆã¦ã„ããŸã„ã¨æ€ã„ã¾ã—ãŸã€‚
