---
title: "Vcontainerã‚’åˆ©ç”¨ã—ã¦MVPãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¡¨ç¾ã—ã¦ã¿ãŸ"
emoji: "ğŸ™Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [unity, mvp, vcontainer, csharp, designpattern, architecture, unity3d]
published: true
publication_name: midra_lab
---
## ã¯ã˜ã‚ã«
æ™®æ®µã‹ã‚‰ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³å…ˆã‚„å€‹äººã§Unityã‚’åˆ©ç”¨ã—ã¦é–‹ç™ºã™ã‚‹ã“ã¨ãŒå¤šã„ã®ã§ã™ãŒã€
è¨­è¨ˆã®æ·±ãç²¾é€šã—ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„ã®ã§ã€é–“é•ã„ãªã©ãŒã‚ã‚Šã¾ã—ãŸã‚‰ã”æŒ‡æ‘˜ã„ãŸã ã‘ã‚‹ã¨å¹¸ã„ã§ã™ã€‚

## MVPãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã¯
MVPãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã¯ã€Model-View-Presenterã®ç•¥ã§ã€Model(ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã©ã®å€¤ã‚’æŒã¤ã‚¯ãƒ©ã‚¹)ã¨View(ç”»é¢ã®è¡¨ç¤º, å…¥åŠ›ãªã©ã‚’è¡Œã†ã‚¯ãƒ©ã‚¹)ã®é–“ã«Presenterã‚’æŒŸã‚€ã“ã¨ã§ã€
Viewã¨Modelã®ä¾å­˜é–¢ä¿‚ã‚’ãªãã™ã“ã¨ãŒã§ãã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚

## Vcontainerã¨ã¯
> é€šå¸¸ã€Unityã¯ MonoBehaviour ã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹ã®ã¿ã‚’å‡¦ç†ã®èµ·ç‚¹ã«ã§ãã¾ã™ãŒã€VContainerã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåŒå£«ã®å‚ç…§é–¢ä¿‚/æ‰€æœ‰é–¢ä¿‚ã‚’è‡ªç”±ã«æ§‹ç¯‰ã—ãŸã‚Šã€ç´”ç²‹ãªC# ã‚¯ãƒ©ã‚¹ã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã‚’ã¤ãã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã¯Unityã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ä¾å­˜ã™ã‚‹éƒ¨åˆ†ãƒ»è¦‹ãŸç›®ã®éƒ¨åˆ†ã¨ã€ãã®ä»–ç´”ç²‹ãªãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ†é›¢ã™ã‚‹è¨­è¨ˆã®æ‰‹åŠ©ã‘ã«ãªã‚Šã¾ã™ã€‚ 
> ã“ã®ã‚ˆã†ãªåˆ¶å¾¡ã®åè»¢ã¯IoC(Inversion of Control) ãªã©ã¨å‘¼ã°ã‚Œã¦ã„ã¦ã€DIã‚³ãƒ³ãƒ†ãƒŠã®è¨­è¨ˆä¸Šã®åˆ©ç‚¹ã®ã²ã¨ã¤ã§ã™ã€‚
> å¼•ç”¨å…ƒ (https://vcontainer.hadashikick.jp/ja/) 

ã“ã¡ã‚‰ã‚’ã¿ã¦ã„ãŸã ãã¨é–“é•ã„ã‚ã‚Šã¾ã›ã‚“ã€‚

## ä»Šå›ã®ã‚µãƒ³ãƒ—ãƒ«

(https://github.com/eiei114/VcontainerMVPsample)

## MVPãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¡¨ç¾ã—ã¦ã¿ãŸ
ä»Šå›ã¯[UniTask](https://github.com/Cysharp/UniTask)ã‚’åˆ©ç”¨ã—ã¦éåŒæœŸå‡¦ç†ã‚’è¡Œã†ã“ã¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚
### Model
```csharp
ã€€ã€€ public class Model
    {
        private readonly AsyncReactiveProperty<int> _score = new(0);

        public IReadOnlyAsyncReactiveProperty<int> Score => _score;
        
        public void AddScore()
        {
            _score.Value++;
        }
    }
```
Modelã¯ã€ä»Šå›ã¯ã‚¹ã‚³ã‚¢ã‚’æŒã£ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚
UniTaskã®AsyncReactivePropertyã‚’åˆ©ç”¨ã—ã¦ã€å€¤ã®å¤‰æ›´ã‚’é€šçŸ¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã‚¹ã‚³ã‚¢ã‚’ï¼‘å¢—ã‚„ã™ã¨ã„ã†é–¢æ•°ã‚’ç”¨æ„ã—ã¦ã„ã¾ã™ã€‚

### View
```csharp
    public class View : MonoBehaviour
    {
           [SerializeField]private Button _button;
           [SerializeField]private Text _text;
    
           public UnityEvent ButtonClick => _button.onClick;
           public string Text { set=> _text.text = value;}
    }
```
ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ã„ã†é€šçŸ¥ã‚’é€ã‚‹ãŸã‚ã«UnityEventã‚’åˆ©ç”¨ã—ã€textã‚’å¤‰æ›´ã™ã‚‹ãŸã‚ã«stringã®ã‚»ãƒƒã‚¿ãƒ¼ã‚’ç”¨æ„ã—ã¦ã„ã¾ã™ã€‚

### Presenter
```csharp
    public class Presenter : IDisposable,IInitializable
    {
        private readonly CancellationTokenSource _cts = new();
        private readonly Model _model;
        private readonly View _view;
        
        [Inject]
        private Presenter(Model model, View view)
        {
            _model = model;
            _view = view;
        }

        public void Initialize()
        {
            Debug.Log("Presenter.Initialize");
            _view.ButtonClick.AddListener(_model.AddScore);

            _model.Score.Subscribe(x => _view.Text = x.ToString());
        }
        
        public void Dispose()
        {
            _cts.Cancel();
            _cts?.Dispose();
        }
    }
```
IDisposable,IInitializableã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚IDisposableã¯PresenterãŒç ´æ£„ã•ã‚ŒãŸã¨ãã«å‘¼ã°ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
IInitializableã¯Presenterã«ä¾å­˜å…ˆãŒæ³¨å…¥ã•ã‚ŒåˆæœŸåŒ–ã•ã‚ŒãŸã¨ãã«å‘¼ã°ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚(ã“ã¡ã‚‰ã«é–¢ã—ã¦ã¯å¾Œã»ã©è©³ã—ãèª¬æ˜ã—ã¾ã™ã€‚)

Initializeãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯ã€Viewã®ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã«Modelã®ã‚¹ã‚³ã‚¢ã‚’å¢—ã‚„ã™ã‚ˆã†ã«ã—ã¦ã„ã¦ã‚¹ã‚³ã‚¢ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«Viewã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰æ›´ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

Disposeãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯ã€CancellationTokenSourceã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¨ç ´æ£„ã‚’ã—ã¦ã„ã¾ã™ã€‚

## LifeTimeScope
```csharp
    public class RootLifeTimeScope : LifetimeScope
    {
        [SerializeField]private View _view;
        
        protected override void Configure(IContainerBuilder builder)
        {
            builder.RegisterEntryPoint<Presenter>();
            builder.Register<Model>(Lifetime.Singleton);
            builder.RegisterComponent(_view);
        }
    }
```
RootLifeTimeScopeã¯ã€Vcontainerã®LifeTimeScopeã‚’ç¶™æ‰¿ã—ã¦ã„ã¾ã™ã€‚
Configureãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯ã€ä¾å­˜æ€§ã®æ³¨å…¥ã‚’ã—ãŸã„ã‚¯ãƒ©ã‚¹ã‚„æ³¨å…¥ã™ã‚‹ã‚¯ãƒ©ã‚¹ã®ç™»éŒ²ã‚’è¡Œã„ã¾ã™ã€‚

`builder.RegisterEntryPoint<Presenter>();`ã§ã¯ã€Presenterã‚’ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ç™»éŒ²ã—ã¦ã„ã¾ã™ã€‚
ã“ã®ç™»éŒ²æ–¹æ³•ã ã¨Vcontainerã®æŒ‡å®šã®interfaceã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§MonoBehaviourã®æŒã¤startã‚„awakeãªã©ã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã‚’
é€šå¸¸ã®C#ã®ã‚¯ãƒ©ã‚¹ã¨åŒã˜ã‚ˆã†ã«åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

`builder.Register<Model>(Lifetime.Singleton);`ã§ã¯ã€Modelã‚’ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã§ç™»éŒ²ã—ã¦ã„ã¾ã™ã€‚
`Lifetime.Singleton`ã§ç™»éŒ²ã™ã‚‹ã“ã¨ã§ã“ã®Modelã‚¯ãƒ©ã‚¹ãŒå…¨ã¦åŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ã—ã¦æ³¨å…¥ã§ãã¾ã™ã€‚
`Lifetime.Transient`ã§ç™»éŒ²ã™ã‚‹ã“ã¨ã§ã“ã®Modelã‚¯ãƒ©ã‚¹ãŒå…¨ã¦ç•°ãªã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ã—ã¦æ³¨å…¥ã§ãã¾ã™ã€‚

`builder.RegisterComponent(_view);`ã§ã¯ã€Viewã‚’ç™»éŒ²ã—ã¦ã„ã¾ã™ã€‚
`RegisterComponent`ã§ç™»éŒ²ã™ã‚‹ã“ã¨ã§ã€MonoBehaviourã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹ã‚’ç™»éŒ²ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## Unityä¸Šã®çŠ¶æ…‹
![](/images/606664fdf15340/unity_view.png)